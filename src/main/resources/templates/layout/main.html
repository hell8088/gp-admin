<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org">
<head lang="en">
<meta charset="utf-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<title>gp-admin</title>

<link rel="stylesheet" th:href="@{/assets/layui/css/layui.css}" />
<link rel="stylesheet" th:href="@{/assets/common.css}" />



<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
	BASE_URL = /*[[@{/}]]*/'';
	/*]]>*/
</script>

<script type="text/javascript" th:inline="javascript">
	/*<![CDATA[*/
	RESOURCE_URL = /*[[@{/assets/}]]*/'';
	/*]]>*/
</script>

</head>
<body class="layui-layout-body">
	<script th:src="@{/assets/layui/layui.js}"></script>
	<script th:src="@{/assets/jquery-3.2.1.min.js}"></script>

	<div class="layui-layout layui-layout-admin">
		<div class="layui-header">
			<div class="layui-logo">gp-admin 开源系统</div>
			<!-- 头部区域（可配合layui已有的水平导航） -->
			<!-- <ul class="layui-nav layui-layout-left">
				<li class="layui-nav-item"><a href="">控制台</a></li>
				<li class="layui-nav-item"><a href="javascript:;">其它系统</a>
					<dl class="layui-nav-child">
						<dd>
							<a href="">邮件管理</a>
						</dd>
					</dl>
				</li>
			</ul> -->
			<ul class="layui-nav layui-layout-right">
				<li class="layui-nav-item"><a href="javascript:;"> <img
						src="http://t.cn/RCzsdCq" class="layui-nav-img"> wjh
				</a>
					<dl class="layui-nav-child">
						<dd>
							<a href="">基本资料</a>
						</dd>
						<dd>
							<a href="">安全设置</a>
						</dd>
					</dl></li>
				<li class="layui-nav-item"><a href="">退了</a></li>
			</ul>
		</div>

		<div class="layui-side layui-bg-black">
			<div class="layui-side-scroll">
				<!-- 左侧导航区域（可配合layui已有的垂直导航） -->
				<ul id="main-leftmenu" class="layui-nav layui-nav-tree"
					lay-filter="test">
				</ul>
				<input type="hidden" id="currentNode" value=""/>
				<input type="hidden" id="currentExp" value=""/>
			</div>
		</div>

		<div class="layui-body">
			<!-- 内容主体区域 -->
			<main role="main">
			<div class=" pt-3 px-4" layout:fragment="content" th:remove="tag"></div>
			</main>
		</div>

		<div class="layui-footer">
			<!-- 底部固定区域 -->
			@gp-admin auth:wjh
		</div>
	</div>

	<script>
		//JavaScript代码区域
		layui.use('element', function() {
			var element = layui.element;
			loadLeftnav();
		});
		
		function loadLeftnav(){
			var menuArry = [];　　
			params = {
				pid : 0
			};
			$.ajax({
				type : "post",
				data : params,
				url : "/api/resource/leftnav",
				success : function(data) {
					menuArry = data;
					initLeftMenu(menuArry, 1);
				}
			});
		}
		
		//初始化左侧菜单
		function initLeftMenu(menuArry, pId) {
			//获取左侧菜单并清理所有节点
			var main_ul = $("#main-leftmenu");
			main_ul.children("li").remove();

			//拆分1级节点和子节点
			var tops = new Array();
			var childrens = new Array();
			var currentUrl = window.location.href;
			
			for ( var i in menuArry) {
				if(menuArry[i].pid==0){
					continue;
				}
				if (menuArry[i].pId == pId){
					tops.push(menuArry[i]);}
				else{
					childrens.push(menuArry[i]);
					if(currentUrl.indexOf(menuArry[i].url)!=-1){
						$("#currentNode").val(menuArry[i].id);
						$("#currentExp").val(menuArry[i].pId);
					}
				}
			}
			
			for ( var j in tops) {
				var node_li = "<li id='res_"+tops[j].id+"' class='layui-nav-item'>";
				node_li += "<a class='' href=javascript:expend("+tops[j].id+");>"+ tops[j].name +"</a>"
				var childArry = getChildrens(tops[j].id, childrens);
				if (childArry.length > 0) {
					node_li += "<dl class='layui-nav-child'>"
					node_li += addNode(tops[j], childArry, currentUrl);
					node_li += "</dl>"
				}
				node_li += "</li>";
				main_ul.append(node_li);
			}
			
			expend($("#currentExp").val());
			nodeSelect($("#currentNode").val())
		}

		function addNode(node, childrens, currentUrl) {
			var sub_li = "";
			for(k in childrens){
				sub_li += "<dd id='dd_"+childrens[k].id+"'>";
				sub_li += "<a href=javascript:url_for('"+childrens[k].url+"');>" + childrens[k].name + "</a>";
				sub_li += "</dd>";
			}
			return sub_li;
		}

		function getChildrens(pId, childrens) {
			var newArry = new Array();
			for ( var i in childrens) {
				if (childrens[i].pId == pId)
					newArry.push(childrens[i]);
			}
			return newArry;
		}
		
		function expend(obj){
			var id = "#res_" + obj;
			$(id).toggleClass("layui-nav-itemed");
		}
		
		function nodeSelect(obj){
			var id = "#dd_" + obj;
			$(id).toggleClass("layui-this");
		}
		
		function url_for(url){
			window.location.href=url;
		}
	</script>
</body>
</html>